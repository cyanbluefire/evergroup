<!DOCTYPE html>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<script src="jquery-2.1.3.min.js" type="text/javascript"></script>
		<style type="text/css">
			body,
			html,
			#l-map {
				width: 100%;
				height: 100%;
				overflow: hidden;
				margin: 0;
			}
		</style>
		<script type="text/javascript" src="http://api.map.baidu.com/api?type=quick&ak=cElCR5PGh4nlvqxeMb26Mmkr&v=1.0"></script>
		<script type="text/javascript" src="RichMarker.js"></script>
		<title>显示地图</title>
	</head>

	<body>
		<div id="l-map"></div>

	</body>

</html>
<script type="text/javascript">
	$(function() {
		function getLocation() {
				if (navigator.geolocation) {
					navigator.geolocation.getCurrentPosition(function(position) {
						$.ajax({
							type: "post",
							url: "http://api.map.baidu.com/geoconv/v1/?coords=" + position.coords.longitude + "," + position.coords.latitude + "&from=1&to=5&ak=cElCR5PGh4nlvqxeMb26Mmkr",
							async: true,
							dataType: "json",
							success: function(data) {
								showPosition(data.result[0].x, data.result[0].y);
							}
						});
					}, showError);
				} else {
					alert("本设备不支持定位哦");
				}
			}
			// 定位失败时，执行的函数 

		function showError(error) {
			switch (error.code) {
				case error.PERMISSION_DENIED:
					alert("请在“设置”中开启“位置信息”后再使用哦");
					break;
				case error.POSITION_UNAVAILABLE:
					alert("Location information is unavailable.");
					break;
				case error.TIMEOUT:
					alert("The request to get user location timed out.");
					break;
				case error.UNKNOWN_ERROR:
					alert("An unknown error occurred.");
					break;
			}
		}

		function showPosition(x, y) {
			var map = new BMap.Map("l-map");
			map.centerAndZoom(new BMap.Point(x, y), 20);
			map.addControl(new BMap.ZoomControl()); //添加地图缩放控件
			//定位
			var marker_me = new BMap.Marker(new BMap.Point(x, y)); //创建标注
			map.addOverlay(marker_me); // 将标注添加到地图中
			console.log("x:" + x + " y:" + y);
			//标注商家
			var myIcon = new BMap.Icon("img/ratio.png", new BMap.Size(53, 53));
			var marker1 = new BMap.Marker(new BMap.Point(113.94049705331, 22.548550620923), {
				icon: myIcon
			}); //创建标注
			map.addOverlay(marker1); // 将标注添加到地图中
			marker1.addEventListener('click', startGroupChat);
			//富标注测试
			//				var htm = '<div><img src="img/ratio.png" alt="sex ratio"/></div>'
			//				var RichMasrker = new BMapLib.RichMarker(htm,new BMap.Point(113.94249705331, 22.548550620923), {"anchor": new BMap.Size(-72, -84), "enableDragging": true});
			//				RichMasrker.setContent('1');
			//				map.addOverlay(RichMasrker);
			//				RichMasrker.addEventListener('onclick',function(e){
			//					alert(e.type);
			//					alert(e.getCotent());
			//				})
			var htm1 = "<div id='overLay' style='width:93px;height:116px; left top no-repeat; position: absolute;'>" + "<img style='margin-left:9px;margin-top: 8px;' src='img/ratio.png' />" + "<p>1</p>" + "</div>",
				myRichMarker1 = new BMapLib.RichMarker(htm1, new BMap.Point(113.94249705331, 22.548550620923), {
					"anchor": new BMap.Size(-47, -116),
					"enableDragging": true
				});
			map.addOverlay(myRichMarker1);
			myRichMarker1.addEventListener('onclick', function(e) {
				alert(e.type);
				alert(e.target.getContent());
			});
		}

		function startGroupChat() {
			map.removeOverlay(marker1);
			window.location = 'groupChat.html';
		}
		window.onload = getLocation;
	})
</script>